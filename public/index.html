<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Verifica Webcam</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #video { width: 100%; max-width: 400px; border-radius: 12px; margin: 20px 0; }
    #status { font-size: 18px; margin: 15px 0; color: #0f0; }
    button { margin: 10px 0; }
  </style>
</head>
<body>
<div id="box">
  <h2>Verifica Webcam in tempo reale</h2>
  
  <input id="user" placeholder="Il tuo nome" value="Utente123">
  
  <button id="consenti">Tu adesso</button>
  <button id="stop" style="display:none; background:#ff4444;">⛔ Stop</button>
  
  <video id="video" autoplay playsinline muted></video>
  <div id="status"></div>
</div>

<script>
  const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host);
  let stream = null;
  let interval = null;
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  document.getElementById('consenti').onclick = async () => {
    const username = document.getElementById('user').value || "Anonymous";
    
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      video.play();
      
      document.getElementById('consenti').style.display = 'none';
      document.getElementById('stop').style.display = 'block';
      
      document.getElementById('status').textContent = '';  // vuoto come prima
      
      interval = setInterval(() => {
        if (!video.videoWidth) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        const base64 = canvas.toDataURL('image/jpeg', 0.7);
        
        ws.send(JSON.stringify({
          user: username,
          type: 'webcam_frame',
          image: base64
        }));
      }, 2000);
      
    } catch (err) {
      alert("❌ Non hai dato il permesso alla webcam o non hai una camera.");
      console.error(err);
    }
  };

  document.getElementById('stop').onclick = () => {
    if (interval) clearInterval(interval);
    if (stream) stream.getTracks().forEach(track => track.stop());
    video.srcObject = null;
    document.getElementById('consenti').style.display = 'block';
    document.getElementById('stop').style.display = 'none';
    document.getElementById('status').textContent = '';
  };

  window.onbeforeunload = () => { if (stream) stream.getTracks().forEach(t => t.stop()); };
</script>
</body>
</html>