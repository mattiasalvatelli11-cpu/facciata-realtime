<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Admin â€“ Verifiche</title>
  <style>
    body { font-family:Arial; background:#f0f0f0; padding:20px; margin:0; }
    h1 { text-align:center; }
    #feed { max-width:900px; margin:0 auto; }
    .user-box { background:white; border-radius:8px; padding:15px; margin:20px 0; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    video { width:100%; max-width:600px; background:#000; border-radius:6px; }
    button { padding:10px 20px; font-size:16px; margin:10px 5px; cursor:pointer; }
    #saveBtn { background:#28a745; color:white; border:none; }
    #stopBtn { background:#dc3545; color:white; border:none; }
  </style>
</head>
<body>
<h1>Verifiche in arrivo</h1>
<div id="feed"></div>

<script>
  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
  let mediaSource = null;
  let sourceBuffer = null;
  let recordedChunks = [];
  let recorder = null;
  let videoEl = null;

  ws.onopen = () => console.log('WS connesso');

  ws.onmessage = (event) => {
    if (event.data instanceof Blob) {
      console.log('Chunk ricevuto, size:', event.data.size);

      if (!mediaSource) {
        initVideoPlayer();
      }

      event.data.arrayBuffer().then(buffer => {
        if (sourceBuffer && sourceBuffer.readyState === 'open' && !sourceBuffer.updating) {
          try {
            sourceBuffer.appendBuffer(buffer);
            console.log('Append ok');
            if (videoEl.paused) {
              videoEl.play().catch(e => console.log('Play auto fallito:', e));
            }
          } catch (e) {
            console.error('Append error:', e);
          }

          if (!recorder) {
            setTimeout(() => {
              const stream = videoEl.captureStream ? videoEl.captureStream() : videoEl.mozCaptureStream();
              if (stream) {
                recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                recorder.ondataavailable = e => {
                  if (e.data.size > 0) recordedChunks.push(e.data);
                };
                recorder.start();
                console.log('Recorder locale partito');
              }
            }, 3000); // delay per aspettare header validi
          }
        } else {
          console.log('SourceBuffer non pronto:', sourceBuffer ? sourceBuffer.readyState : 'null');
        }
      });
    }
  };

  function initVideoPlayer() {
    const container = document.getElementById('feed');
    const box = document.createElement('div');
    box.className = 'user-box';

    videoEl = document.createElement('video');
    videoEl.autoplay = true;
    videoEl.controls = true;
    box.appendChild(videoEl);

    const saveBtn = document.createElement('button');
    saveBtn.id = 'saveBtn';
    saveBtn.textContent = 'Salva Video Completo';
    saveBtn.onclick = saveVideo;
    box.appendChild(saveBtn);

    const stopBtn = document.createElement('button');
    stopBtn.id = 'stopBtn';
    stopBtn.textContent = 'Ferma e Salva';
    stopBtn.onclick = stopAndSave;
    box.appendChild(stopBtn);

    container.appendChild(box);

    mediaSource = new MediaSource();
    videoEl.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
      try {
        sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
        sourceBuffer.mode = 'sequence';
        console.log('SourceBuffer aperto');
        videoEl.play().catch(e => console.log('Play auto:', e));
      } catch (e) {
        console.error('addSourceBuffer error:', e);
      }
    });
  }

  function saveVideo() {
    if (recorder) {
      recorder.requestData();
      setTimeout(() => {
        recorder.stop();
        recorder = null;
        downloadVideo();
      }, 500);
    } else {
      downloadVideo();
    }
  }

  function stopAndSave() {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'stop' }));
    }
    saveVideo();
  }

  function downloadVideo() {
    setTimeout(() => {
      if (recordedChunks.length > 0) {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `verifica_${new Date().toISOString().slice(0,19).replace('T','_')}.webm`;
        a.click();
        URL.revokeObjectURL(url);
        recordedChunks = [];
      }
    }, 800);
  }

  ws.onclose = () => console.log('WS disconnesso');
</script>
</body>
</html>