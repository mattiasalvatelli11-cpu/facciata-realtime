<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Admin â€“ Verifiche</title>
  <style>
    body { font-family:Arial; background:#f0f0f0; padding:20px; margin:0; }
    h1 { text-align:center; }
    #feed { max-width:900px; margin:0 auto; }
    .user-box { background:white; border-radius:8px; padding:15px; margin:20px 0; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    video { width:100%; max-width:600px; background:#000; border-radius:6px; }
    button { padding:10px 20px; font-size:16px; margin:10px 5px; cursor:pointer; }
    #saveBtn { background:#28a745; color:white; border:none; }
    #stopBtn { background:#dc3545; color:white; border:none; }
  </style>
</head>
<body>
<h1>Verifiche in arrivo</h1>
<div id="feed"></div>

<script>
  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
  let mediaSource = null;
  let sourceBuffer = null;
  let recordedChunks = [];
  let recorder = null;
  let videoEl = null;

  ws.onopen = () => console.log('Connesso');

  ws.onmessage = (event) => {
    if (event.data instanceof Blob) {
      if (!mediaSource) initVideoPlayer();

      event.data.arrayBuffer().then(buffer => {
        if (sourceBuffer && sourceBuffer.readyState === 'open' && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(buffer);
          if (videoEl.paused) videoEl.play().catch(() => {});
        }
      });

      if (!recorder) {
        setTimeout(() => {
          const stream = videoEl.captureStream ? videoEl.captureStream() : videoEl.mozCaptureStream();
          recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
          recorder.ondataavailable = e => recordedChunks.push(e.data);
          recorder.start();
        }, 3000);
      }
    }
  };

  function initVideoPlayer() {
    const container = document.getElementById('feed');
    const box = document.createElement('div');
    box.className = 'user-box';

    videoEl = document.createElement('video');
    videoEl.autoplay = true;
    videoEl.controls = true;
    box.appendChild(videoEl);

    const saveBtn = document.createElement('button');
    saveBtn.id = 'saveBtn';
    saveBtn.textContent = 'Salva Video Completo';
    saveBtn.onclick = saveVideo;
    box.appendChild(saveBtn);

    const stopBtn = document.createElement('button');
    stopBtn.id = 'stopBtn';
    stopBtn.textContent = 'Ferma e Salva';
    stopBtn.onclick = stopAndSave;
    box.appendChild(stopBtn);

    container.appendChild(box);

    mediaSource = new MediaSource();
    videoEl.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
      sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
      sourceBuffer.mode = 'sequence';
      videoEl.play().catch(() => {});
    });
  }

  function saveVideo() {
    if (recorder) recorder.requestData();
    setTimeout(() => {
      if (recorder) recorder.stop();
      if (recordedChunks.length) {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `verifica_${Date.now()}.webm`;
        a.click();
        recordedChunks = [];
      }
    }, 800);
  }

  function stopAndSave() {
    ws.send(JSON.stringify({ type: 'stop' }));
    saveVideo();
  }
</script>
</body>
</html>